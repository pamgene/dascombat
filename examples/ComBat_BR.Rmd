---
title: "R Notebook"
output:
  pdf_document: default
  html_notebook: default
---

# Different naming of bx for correction

-SFactor7 = PB23001 -> bx.identifier = "NEW"

-SFactor7 = PB25001 -> bx.identifier = "DB"

-bx_correct = bx.identifier

-bx_bg = SFactor7

```{r, echo = FALSE, message = FALSE}
rm(list = ls())
library(tidyverse)
library(dascombat)
library(reshape2)

print(getwd())
pb = readRDS("PB23001_PB25001_H.RDS")

pb = pb %>% 
  mutate(pcRun = substr(Barcode, 3,6)) %>% 
  mutate(run_date = paste(pcRun, Date, sep = "_")) %>% 
  mutate(measID = paste(Barcode, Array, sep = "_")) %>% 
  mutate(bx.identifier = case_when(SFactor7 == "PB23001" ~ "NEW",
                              SFactor7 == "PB25001" ~ "DB",
                              TRUE ~ NA_character_))


X = pb %>% 
  reshape2::acast(ID ~Barcode + Array, value.var = "value")
bx_correct = pb %>%
  reshape2::acast(ID ~Barcode + Array, value.var = "bx.identifier")

bx_correct = bx_correct[1,] %>% 
  as.factor()

bx_bg = pb %>%
  reshape2::acast(ID ~Barcode + Array, value.var = "SFactor7")

bx_bg = bx_bg[1,] %>%
  as.factor() 

```
# basic processing

```{r, echo = FALSE, message = FALSE}

runDate = pb %>%
  reshape2::acast(ID ~Barcode + Array, value.var = "run_date")

runDate = runDate[1,] %>%
  as.factor()

# For clarity apply an correction for runDate first

model = dascombat::fit(X, runDate, mean.only = FALSE)
Y = dascombat::applyModel(X, model, model$bx)

```
# 1. PCA visual of uncorrected data

```{r}
aPca = prcomp(t(Y))

dfs = aPca$x %>% 
  as.data.frame() %>% 
  rownames_to_column("Sample") %>% 
  separate(Sample, into = c("Barcode", "Array"), sep = "_") 

meta = pb %>% 
  filter(rowSeq == 1) %>% 
  select(Barcode, Array, SFactor7, bx.identifier, pcRun, Date, measID)

dfs = dfs %>% 
  left_join(meta, by = c("Barcode", "Array"))

dfs %>% 
  ggplot(aes(x = PC1, y = PC2, color = bx.identifier, shape = SFactor7)) +
  geom_point()


```

# 2.  PCA visual of corrected data
- Using bx_correct for ComBat \underline {without} reference batch


# <span style="color:  green;"> correct </span>

```{r}
model2 = dascombat::fit(Y, bx_correct, mean.only = FALSE, ref.batch = NULL)
Y2 = dascombat::applyModel(Y, model2, model2$bx)

aPca2 = prcomp(t(Y2))
dfs2 = aPca2$x %>%
  as.data.frame() %>% 
  rownames_to_column("Sample") %>% 
  separate(Sample, into = c("Barcode", "Array"), sep = "_")
dfs2 = dfs2 %>%
  left_join(meta, by = c("Barcode", "Array"))

ggplot(dfs2, aes(x = PC1, y = PC2, color = bx.identifier, shape = SFactor7)) +
  geom_point()

```

# 3. PCA visual of corrected data
- Using bx_bg for ComBat \underline{without} reference batch

# <span style="color:  green;"> correct </span>

```{r}


model3 = dascombat::fit(Y, bx_bg, mean.only = FALSE, ref.batch = NULL)
Y3 = dascombat::applyModel(Y, model3, model3$bx)
aPca3 = prcomp(t(Y3))
dfs3 = aPca3$x %>%
  as.data.frame() %>%
  rownames_to_column("Sample") %>%
  separate(Sample, into = c("Barcode", "Array"), sep = "_")
dfs3 = dfs3 %>%
  left_join(meta, by = c("Barcode", "Array"))
ggplot(dfs3, aes(x = PC1, y = PC2, color = bx.identifier, shape = SFactor7)) +
  geom_point()

```

# 4. PCA visual of corrected data
- Using bx_correct for ComBat \underline{with} reference batch = "DB"

# <span style="color:  green;"> correct </span>

```{r}

model4 = dascombat::fit(Y, bx_correct, mean.only = FALSE, ref.batch = "DB")
Y4 = dascombat::applyModel(Y, model4, model4$bx)
aPca4 = prcomp(t(Y4))
dfs4 = aPca4$x %>%
  as.data.frame() %>%
  rownames_to_column("Sample") %>%
  separate(Sample, into = c("Barcode", "Array"), sep = "_")
dfs4 = dfs4 %>%
  left_join(meta, by = c("Barcode", "Array"))

ggplot(dfs4, aes(x = PC1, y = PC2, color = bx.identifier, shape = SFactor7)) +
  geom_point()
  

```

# 5. PCA visual of corrected data
- Using bx_correct for ComBat \underline{with} reference batch = "NEW"

# <span style="color:  red;"> FAIL </span>

```{r}  

model5 = dascombat::fit(Y, bx_correct, mean.only = FALSE, ref.batch = "NEW")
Y5 = dascombat::applyModel(Y, model5, model5$bx)
aPca5 = prcomp(t(Y5))
dfs5 = aPca5$x %>%
  as.data.frame() %>%
  rownames_to_column("Sample") %>%
  separate(Sample, into = c("Barcode", "Array"), sep = "_")
dfs5 = dfs5 %>%
  left_join(meta, by = c("Barcode", "Array"))
ggplot(dfs5, aes(x = PC1, y = PC2, color = bx.identifier, shape = SFactor7)) +
  geom_point()


```


# 6: PCA visual of corrected data
- Using bx_bg for ComBat \underline{with} reference batch = "PB23001"

# <span style="color:  green;"> correct </span>

```{r}
model6 = dascombat::fit(Y, bx_bg, mean.only = FALSE, ref.batch = "PB23001")
Y6 = dascombat::applyModel(Y, model6, model6$bx)
aPca6 = prcomp(t(Y6))
dfs6 = aPca6$x %>%
  as.data.frame() %>%
  rownames_to_column("Sample") %>%
  separate(Sample, into = c("Barcode", "Array"), sep = "_")
dfs6 = dfs6 %>%
  left_join(meta, by = c("Barcode", "Array"))

ggplot(dfs6, aes(x = PC1, y = PC2, color = bx.identifier, shape = SFactor7)) +
  geom_point()

```
# 7: PCA visual of corrected data
- Using bx_bg for ComBat \underline{with} reference batch = "PB25001"

# <span style="color:  red;"> FAIL </span>

```{r}
model7 = dascombat::fit(Y, bx_bg, mean.only = FALSE, ref.batch= "PB25001")
Y7 = dascombat::applyModel(Y, model7, model7$bx)
aPca7 = prcomp(t(Y7))
dfs7 = aPca7$x %>%
  as.data.frame() %>%
  rownames_to_column("Sample") %>%
  separate(Sample, into = c("Barcode", "Array"), sep = "_")
dfs7 = dfs7 %>%
  left_join(meta, by = c("Barcode", "Array"))
ggplot(dfs7, aes(x = PC1, y = PC2, color = bx.identifier, shape = SFactor7)) +
  geom_point()
```









